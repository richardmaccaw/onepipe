name: Generate Deploy Branch

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  generate-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build packages
        run: |
          pnpm install
          pnpm build

      - name: Create deployable version
        run: |
          # Create a minimal pnpm workspace that includes packages but no workspace protocol
          cat > pnpm-workspace-deploy.yaml << 'EOF'
          packages: []
          EOF

          # Append catalog section from original workspace
          grep -A 100 "^catalog:" pnpm-workspace.yaml >> pnpm-workspace-deploy.yaml

          # Install json utility if needed
          npm install -g json

          # Create flattened package.json by removing workspace dependencies
          json -I -f package.json \
            -e "delete this.dependencies['@onepipe/core']" \
            -e "delete this.dependencies['@onepipe/destination-bigquery']" \
            -e "this.scripts = {deploy: 'wrangler deploy', dev: 'wrangler dev'}"

          # Move workspace file into place
          mv pnpm-workspace-deploy.yaml pnpm-workspace.yaml

          # Install to resolve all catalogs
          pnpm install

          # Remove workspace file (not needed in final deploy)
          rm pnpm-workspace.yaml

          # Create flattened file structure with built packages
          mkdir -p src/lib/core src/lib/destinations/bigquery
          cp packages/core/dist/index.* src/lib/core/
          cp packages/destination-bigquery/dist/index.* src/lib/destinations/bigquery/
          cp wrangler.toml onepipe.config.json worker-configuration.d.ts .

          # Transform imports to use local files
          find src -name "*.ts" -exec sed -i.bak "s|@onepipe/core|./lib/core|g" {} \;
          find src -name "*.ts" -exec sed -i.bak "s|@onepipe/destination-bigquery|./lib/destinations/bigquery|g" {} \;
          find src -name "*.bak" -delete

          # Add deploy-specific README
          cat > README.md << 'EOF'
          # OnePipe - Deploy Ready

          [![Deploy to Cloudflare Workers](https://deploy.workers.cloudflare.com/button)](https://deploy.workers.cloudflare.com/?url=https://github.com/richardmaccaw/onepipe/tree/deploy)

          > **Auto-generated from main branch** - [View source](https://github.com/richardmaccaw/onepipe/tree/main)

          Click the deploy button above for instant deployment to Cloudflare Workers.
          EOF

      - name: Push to deploy branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Deploy version from main@${GITHUB_SHA::7}"
          git push --force origin HEAD:deploy
